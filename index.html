<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>유아른 계산기</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/static/pretendard.css">

  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --line:#e6e8f0; --fg:#0e1116; --muted:#6b7280; --accent:#2563eb; --ink:#ffffff;
      --r-xl:14px; --r-md:12px; --shadow:0 8px 24px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font:14.5px/1.55 Pretendard, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
    }

    .page{max-width:2360px;margin:8px auto;padding:0 14px;
      display:grid;grid-template-columns:3fr 2fr;column-gap:20px;row-gap:0;
      min-height:calc(100dvh - 16px);}
    
    .cat{margin-top:0}
    .cat h3{margin:2px 2px 6px;font-size:14px;font-weight:700;color:#111827;}
    .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
    @media (max-width:1800px){ .grid{grid-template-columns:repeat(4,1fr);} }
    @media (max-width:1180px){ .grid{grid-template-columns:repeat(3,1fr);} }
    @media (max-width:880px){ .grid{grid-template-columns:repeat(2,1fr);} }

    .product{
      background:var(--card);border:1px solid var(--line);border-radius:var(--r-md);
      padding:10px;box-shadow:var(--shadow);
      display:flex;flex-direction:row;gap:8px;align-items:center;
      cursor:pointer;transition:0.2s;
    }
    .product.selected{border:2px solid var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,0.2);}
    
    .p-thumb{width:50px;height:50px;max-width:50px;max-height:50px;border-radius:6px;object-fit:cover;background:#eef2f7;}
    
    .p-info{flex:1;display:flex;flex-direction:column;align-items:flex-start;gap:4px;}
    .p-price{font-size:14px;font-weight:700;color:var(--accent);}
    .p-name{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    
    /* 오른쪽 버튼 세로 정렬 */
    .qtyCol{display:flex;flex-direction:column;align-items:center;gap:4px;}
    .btn{border:1px solid var(--line);background:#f3f5fa;border-radius:8px;
      width:32px;height:32px;cursor:pointer;font-weight:800;font-size:16px;
      display:flex;align-items:center;justify-content:center;}
    .badgeCircle{
      width:32px;height:32px;border-radius:50%;
      border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;
    }
    
    .panel{background:var(--card);border:1px solid var(--line);border-radius:var(--r-xl);
      padding:12px;position:sticky;top:0;align-self:start;box-shadow:var(--shadow);
      max-height:calc(100dvh - 20px);overflow:auto;min-width:560px;}
    .panel h3{margin:0 0 8px;font-size:15px;font-weight:800}
    .empty{padding:14px;border:1px dashed var(--line);border-radius:12px;text-align:center;color:#6b7280;background:#fafbff}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:6px;border-radius:12px;border:1px solid var(--line);table-layout:fixed}
    thead th{background:#f6f7fb;font-weight:700;font-size:12.5px;padding:8px;border-bottom:1px solid var(--line);position:sticky;top:0;}
    tbody td{padding:8px;border-bottom:1px solid var(--line);font-size:13.5px;}
    tbody tr:nth-child(even){background:#fafbff}
    .qtyCtl{display:inline-flex;align-items:center;gap:6px}
    .btn-sm{width:24px;height:24px;border:1px solid var(--line);background:#f3f5fa;border-radius:6px;cursor:pointer;font-weight:800;display:flex;align-items:center;justify-content:center}
    .totals{margin-top:10px;display:flex;flex-direction:column;gap:6px}
    .totalLine{display:flex;justify-content:space-between;align-items:center}
    .gift{font-weight:800}
    .actions{margin-top:10px;display:flex;gap:8px}
    .pay{flex:1;background:var(--accent);border:1px solid var(--accent);color:var(--ink);border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;font-size:15px}
    .note{font-size:12px;color:#6b7280;margin-top:6px}
  </style>
</head>
<body>
  <div class="page">
    <main><div id="cats"></div></main>
    <aside class="panel">
      <h3>선택한 제품</h3>
      <div id="cartEmpty" class="empty">아직 선택된 제품이 없습니다.</div>
      <div id="cartWrap" style="display:none">
        <table>
          <thead>
            <tr>
              <th style="width:50%">상품명</th>
              <th style="width:16%">수량</th>
              <th style="width:17%">단가</th>
              <th style="width:17%">금액</th>
            </tr>
          </thead>
          <tbody id="cartBody"></tbody>
        </table>
        <div class="totals">
          <div class="totalLine"><span>총합</span><strong id="grand">0원</strong></div>
          <div class="totalLine gift"><span>사은품</span><span id="gift">없음</span></div>
        </div>
        <div class="actions"><button id="pay" class="pay">결제</button></div>
      </div>
      <div class="note">전송 후 모든 항목이 초기화됩니다.</div>
    </aside>
  </div>

  <form id="orderForm" method="POST" action="https://docs.google.com/forms/d/e/FORM_ID/formResponse" target="hiddenFrame" style="display:none"></form>
  <iframe name="hiddenFrame" style="display:none"></iframe>

  <script>
    const IMG_BASE = "images"; 
    const catsEl = document.getElementById('cats');
    const cartEmptyEl = document.getElementById('cartEmpty');
    const cartWrapEl = document.getElementById('cartWrap');
    const cartBodyEl = document.getElementById('cartBody');
    const grandEl = document.getElementById('grand');
    const giftEl = document.getElementById('gift');
    const payBtn = document.getElementById('pay');
    const formEl = document.getElementById('orderForm');

    const cart = {};
    const productMap = {};

    function giftBy(total){
      if (total >= 100000) return "마스크팩 + 립밤 중 택1 + 리사이클파우치";
      if (total >= 50000)  return "마스크팩 + 립밤 중 택1";
      if (total >= 30000)  return "마스크팩";
      return "없음";
    }

    function render(){
      Object.keys(productMap).forEach(k=>{
        document.getElementById(`badge-${k}`).textContent = String(cart[k]||0);
        const card = document.getElementById(`card-${k}`);
        if (cart[k] > 0) card.classList.add("selected");
        else card.classList.remove("selected");
      });

      const keys = Object.keys(cart);
      if (!keys.length){
        cartEmptyEl.style.display=''; 
        cartWrapEl.style.display='none'; 
        grandEl.textContent='0원'; 
        giftEl.textContent='없음'; 
        return;
      }
      cartEmptyEl.style.display='none'; 
      cartWrapEl.style.display='';

      let total=0;
      cartBodyEl.innerHTML = keys.map(k=>{
        const p = productMap[k], q = cart[k], sub=q*p.price; total+=sub;
        return `<tr data-key="${k}">
          <td class="nameCell" title="${p.name}">${p.name}</td>
          <td><div class="qtyCtl"><button class="btn-sm" data-act="minus">−</button><span>${q}</span><button class="btn-sm" data-act="plus">＋</button></div></td>
          <td>${p.price.toLocaleString()}원</td>
          <td>${sub.toLocaleString()}원</td>
        </tr>`;
      }).join('');

      grandEl.textContent = `${total.toLocaleString()}원`;
      giftEl.textContent  = giftBy(total);
    }

    cartBodyEl.addEventListener('click',(e)=>{
      const btn=e.target.closest('button'); if(!btn) return;
      const key=e.target.closest('tr')?.dataset?.key; if(!key) return;
      if (btn.dataset.act==='plus') cart[key]=(cart[key]||0)+1;
      else if (btn.dataset.act==='minus'){ if ((cart[key]||0)>0) cart[key]--; if (cart[key]===0) delete cart[key]; }
      render();
    });

    payBtn.addEventListener('click',()=>{
      const keys=Object.keys(cart); if(!keys.length){ alert('상품을 선택하세요.'); return; }
      formEl.innerHTML='';
      keys.forEach(k=>{
        const p=productMap[k], q=cart[k];
        formEl.innerHTML+=`<input type="hidden" name="entry.ITEM_NAME" value="${p.name}">
                            <input type="hidden" name="entry.ITEM_QTY" value="${q}">
                            <input type="hidden" name="entry.ITEM_PRICE" value="${p.price}">`;
      });
      formEl.innerHTML+=`<input type="hidden" name="entry.TOTAL" value="${grandEl.textContent.replace(/[^0-9]/g,'')}">
                          <input type="hidden" name="entry.GIFT" value="${giftEl.textContent}">
                          <input type="hidden" name="entry.TIMESTAMP" value="${(new Date()).toISOString()}">`;
      formEl.submit(); for (const k of keys) delete cart[k]; render();
      window.scrollTo({top:0,behavior:'smooth'}); alert('제출되었습니다.');
    });

    async function loadProducts() {
      const res = await fetch("https://opensheet.elk.sh/1QpbkNSpsAoKhgMbCtHUhz97D5epuUqoGt7esf1-u-fw/sheet1");
      const rows = await res.json();
      const categories = {};
      rows.forEach(r=>{
        const cat=r["카테고리"]||"기타";
        if(!categories[cat]) categories[cat]=[];
        categories[cat].push({name:r["상품명"],price:Number(r["판매가"].replace(/,/g,"")),img:r["이미지"]});
      });

      Object.entries(categories).forEach(([catName,items],ci)=>{
        const sec=document.createElement('section');
        sec.className='cat'; sec.innerHTML=`<h3>${catName}</h3><div class="grid"></div>`;
        const grid=sec.querySelector('.grid');

        items.forEach((p,pi)=>{
          const key=`${ci}-${pi}`; productMap[key]=p;
          const src=p.img.startsWith("http")?p.img:`${IMG_BASE}/${p.img}`;
          const card=document.createElement('div'); card.className='product'; card.id=`card-${key}`;
          card.innerHTML=`
            <img class="p-thumb" alt="${p.name}" src="${src}">
            <div class="p-info">
              <div class="p-price">${p.price.toLocaleString()}원</div>
              <div class="p-name">${p.name}</div>
            </div>
            <div class="qtyCol">
              <button class="btn" data-act="plus">＋</button>
              <div class="badgeCircle" id="badge-${key}">0</div>
              <button class="btn" data-act="minus">−</button>
            </div>`;
          
          card.addEventListener('click',(e)=>{
            const act=e.target?.dataset?.act;
            if(act==='minus'){ if((cart[key]||0)>0) cart[key]--; if(cart[key]===0) delete cart[key]; }
            else if(act==='plus'){ cart[key]=(cart[key]||0)+1; }
            else { cart[key]=(cart[key]||0)+1; }
            render();
          });
          grid.appendChild(card);
        });
        catsEl.appendChild(sec);
      });
      render();
    }
    window.addEventListener("DOMContentLoaded", loadProducts);
  </script>
</body>
</html>
