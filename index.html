<script>
const SHEET_URL = "https://opensheet.elk.sh/1QpbkNSpsAoKhgMbCtHUhz97D5epuUqoGt7esf1-u-fw/sheet1";

let products = [];
let cart = {};

async function loadProducts() {
  try {
    const res = await fetch(SHEET_URL);
    const rows = await res.json();

    // 🔹 안전하게 매핑
    products = rows.map(row => ({
      name: (row["상품명"] || "").trim(),
      price: parseInt((row["판매가"] || "0").toString().replace(/[^\d]/g, "")),
      img: (row["이미지"] || "").trim(),
      category: (row["카테고리"] || "").trim()
    }));

    renderProducts();
  } catch (e) {
    console.error("데이터 불러오기 실패:", e);
  }
}

function renderProducts() {
  const container = document.getElementById("products");
  container.innerHTML = "";

  // 카테고리별 그룹핑
  const grouped = {};
  products.forEach(p => {
    if (!grouped[p.category]) grouped[p.category] = [];
    grouped[p.category].push(p);
  });

  Object.keys(grouped).forEach(cat => {
    const section = document.createElement("div");
    section.innerHTML = `<h3>${cat}</h3>`;
    const grid = document.createElement("div");
    grid.className = "grid";

    grouped[cat].forEach((p, idx) => {
      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <div class="thumb">
          <img src="${p.img}" alt="${p.name}" width="50" height="50">
          <div class="info">
            <div class="name">${p.name}</div>
            <div class="price">${p.price.toLocaleString()}원</div>
          </div>
        </div>
        <div class="qty">
          <button class="minus">-</button>
          <span class="count">${cart[p.name]?.count || 0}</span>
          <button class="plus">+</button>
        </div>
      `;

      // 수량 조절
      card.querySelector(".minus").onclick = () => updateCart(p, -1);
      card.querySelector(".plus").onclick = () => updateCart(p, 1);

      // 카드 클릭 → 수량 +1
      card.onclick = e => {
        if (!e.target.classList.contains("minus") && !e.target.classList.contains("plus")) {
          updateCart(p, 1);
        }
      };

      grid.appendChild(card);
    });

    section.appendChild(grid);
    container.appendChild(section);
  });

  renderCart();
}

function updateCart(product, delta) {
  if (!cart[product.name]) {
    cart[product.name] = { ...product, count: 0 };
  }
  cart[product.name].count += delta;
  if (cart[product.name].count <= 0) {
    delete cart[product.name];
  }
  renderProducts();
}

function renderCart() {
  const panel = document.getElementById("cart");
  panel.innerHTML = "";

  if (Object.keys(cart).length === 0) {
    panel.innerHTML = `<p>아직 선택된 제품이 없습니다.</p>`;
    return;
  }

  Object.values(cart).forEach(item => {
    const line = document.createElement("div");
    line.className = "cart-line";
    line.textContent = `${item.name} × ${item.count}개 = ${(item.count * item.price).toLocaleString()}원`;
    panel.appendChild(line);
  });

  const total = Object.values(cart).reduce((sum, i) => sum + i.count * i.price, 0);
  const totalDiv = document.createElement("div");
  totalDiv.className = "total";
  totalDiv.textContent = `총 합계: ${total.toLocaleString()}원`;
  panel.appendChild(totalDiv);
}

loadProducts();
</script>
