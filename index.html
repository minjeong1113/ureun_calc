<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>유아른 계산기</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/static/pretendard.css">

  <style>
 /* 제품 카드 그리드: 무조건 4칸 */
.grid {
  display:grid;
  grid-template-columns: repeat(4, 1fr); /* 항상 4칸 */
  gap:10px;
  align-items: stretch;
}
@media (max-width:880px){
  .grid{grid-template-columns:repeat(2,1fr);} /* 모바일: 2칸 */
}

/* 제품 카드 */
.product{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r-md);
  padding:10px;
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  justify-content:flex-start; /* 위쪽으로 붙임 */
  gap:6px;                    /* 위쪽 블록과 버튼 사이 기본 간격 */
  cursor:pointer;
  transition:0.2s;
  height:auto;                /* 내용에 맞게 높이 */
  aspect-ratio:auto;          /* 고정 비율 제거 */
}
.product.selected{
  border:2px solid var(--accent);
  box-shadow:0 0 0 3px rgba(37,99,235,0.2);
}

/* 카드 상단(사진+이름+가격) */
.topRow{
  display:flex;
  align-items:center;
  gap:8px;
}
.p-thumb{
  width:42px;
  height:42px;
  border-radius:8px;
  object-fit:cover;
  background:#eef2f7;
}
.p-info{flex:1;display:flex;flex-direction:column;gap:2px;}
.p-name{
  font-size:12.5px;
  font-weight:700;
  line-height:1.35;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:100%;
}
.p-price{font-size:12.5px;color:var(--accent);}

/* 수량 조절 영역 */
.qtyRow{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:6px;
  margin-top:6px; /* 위 블록과 최소 여백 */
}
.btn{
  border:1px solid var(--line);
  background:#f3f5fa;
  border-radius:8px;
  width:28px;height:28px;
  cursor:pointer;font-weight:800;font-size:16px;
  display:flex;align-items:center;justify-content:center;
}
.badge{min-width:34px;text-align:center;font-weight:800;}

  </style>
</head>
<body>
  <div class="page">
    <main><div id="cats"></div></main>
    <aside class="panel">
      <h3>선택한 제품</h3>
      <div id="cartEmpty" class="empty">아직 선택된 제품이 없습니다.</div>
      <div id="cartWrap" style="display:none">
        <table>
          <colgroup>
          <col style="width:180px"> <!-- 상품명 -->
          <col style="width:80px">  <!-- 수량 -->
          <col style="width:100px"> <!-- 단가 -->
          <col style="width:100px"> <!-- 금액 -->
        </colgroup>
        <thead>
          <tr>
            <th>상품명</th>
            <th>수량</th>
            <th>단가</th>
            <th>금액</th>
          </tr>
        </thead>
        <tbody id="cartBody"></tbody>
      </table>
        <div class="totals">
          <div class="totalLine"><span>총합</span><strong id="grand">0원</strong></div>
          <div class="totalLine"><span>총 수량</span><strong id="totalQty">0개</strong></div>
          <div class="totalLine gift"><span>사은품</span><span id="gift">없음</span></div>
        </div>
        <div class="actions"><button id="pay" class="pay">결제</button></div>
      </div>
      <div class="note">전송 후 모든 항목이 초기화됩니다.</div>
    </aside>
  </div>

  <form id="orderForm" method="POST" action="https://docs.google.com/forms/d/e/1FAIpQLScLEBK_7dlg1NY2qcan0z15Z9NtsB6hNzn8pBzoAzWrK7lyHg/formResponse" target="hiddenFrame" style="display:none"></form>
  <iframe name="hiddenFrame" style="display:none"></iframe>
  <script>
    const IMG_BASE = "images"; 
    const catsEl = document.getElementById('cats');
    const cartEmptyEl = document.getElementById('cartEmpty');
    const cartWrapEl = document.getElementById('cartWrap');
    const cartBodyEl = document.getElementById('cartBody');
    const grandEl = document.getElementById('grand');
    const giftEl = document.getElementById('gift');
    const payBtn = document.getElementById('pay');
    const formEl = document.getElementById('orderForm');
    const totalQtyEl = document.getElementById('totalQty');

    const cart = {};
    const productMap = {};

    function giftBy(total){
      if (total >= 100000) return "마스크팩 + 립밤 중 택1 + 리사이클파우치";
      if (total >= 50000)  return "마스크팩 + 립밤 중 택1";
      if (total >= 30000)  return "마스크팩";
      return "없음";
    }

    function render(){
      Object.keys(productMap).forEach(k=>{
        document.getElementById(`badge-${k}`).textContent = String(cart[k]||0);
        const card = document.getElementById(`card-${k}`);
        if (cart[k] > 0) card.classList.add("selected");
        else card.classList.remove("selected");
      });

      const keys = Object.keys(cart);
      if (!keys.length){
        cartEmptyEl.style.display=''; 
        cartWrapEl.style.display='none'; 
        grandEl.textContent='0원'; 
        giftEl.textContent='없음'; 
        totalQtyEl.textContent='0개';
        return;
      }
      cartEmptyEl.style.display='none'; 
      cartWrapEl.style.display='';

      let total=0;
      let totalQty=0;
      cartBodyEl.innerHTML = keys.map(k=>{
        const p = productMap[k], q = cart[k], sub=q*p.price; 
        total+=sub; totalQty+=q;
        return `<tr data-key="${k}">
  <td class="nameCell" title="${p.name}">${p.name}</td>
  <td><div class="qtyCtl">
    <button class="btn-sm" data-act="minus">−</button>
    <span>${q}</span>
    <button class="btn-sm" data-act="plus">＋</button>
  </div></td>
  <td class="priceCell">${p.price.toLocaleString()}원</td>
  <td class="subtotalCell">${sub.toLocaleString()}원</td>
</tr>`;
      }).join('');

      grandEl.textContent = `${total.toLocaleString()}원`;
      giftEl.textContent  = giftBy(total);
      totalQtyEl.textContent = `${totalQty}개`;
    }

    cartBodyEl.addEventListener('click',(e)=>{
      const btn=e.target.closest('button'); if(!btn) return;
      const key=e.target.closest('tr')?.dataset?.key; if(!key) return;
      if (btn.dataset.act==='plus') cart[key]=(cart[key]||0)+1;
      else if (btn.dataset.act==='minus'){ if ((cart[key]||0)>0) cart[key]--; if (cart[key]===0) delete cart[key]; }
      render();
    });
    payBtn.addEventListener('click',()=>{
      const keys=Object.keys(cart); if(!keys.length){ alert('상품을 선택하세요.'); return; }
      formEl.innerHTML='';

      // 시간 기록
      formEl.innerHTML += `<input type="hidden" name="entry.641954362" value="${(new Date()).toISOString()}">`;

      // 상품별 매핑
      keys.forEach(k=>{
        const p=productMap[k], q=cart[k];
        switch(p.name){
          case "올인원 로션": formEl.innerHTML+=`<input type="hidden" name="entry.73760492" value="${q}">`; break;
          case "아하파하 앰플": formEl.innerHTML+=`<input type="hidden" name="entry.527065283" value="${q}">`; break;
          case "사철쑥 에센스": formEl.innerHTML+=`<input type="hidden" name="entry.1954562651" value="${q}">`; break;
          case "수분 앰플 크림": formEl.innerHTML+=`<input type="hidden" name="entry.661056142" value="${q}">`; break;
          case "나이트 크림": formEl.innerHTML+=`<input type="hidden" name="entry.358376705" value="${q}">`; break;
          case "드라이 샴푸 앰플 40ml": formEl.innerHTML+=`<input type="hidden" name="entry.1894876668" value="${q}">`; break;
          case "콩클렌징": formEl.innerHTML+=`<input type="hidden" name="entry.2043302855" value="${q}">`; break;
          case "티트리 모공팩": formEl.innerHTML+=`<input type="hidden" name="entry.209373553" value="${q}">`; break;
          case "에어핏 선세럼": formEl.innerHTML+=`<input type="hidden" name="entry.425801880" value="${q}">`; break;
          case "마스크팩 8매": formEl.innerHTML+=`<input type="hidden" name="entry.1513994656" value="${q}">`; break;
          case "동백 미스트": formEl.innerHTML+=`<input type="hidden" name="entry.2061672077" value="${q}">`; break;
          case "트래블키트": formEl.innerHTML+=`<input type="hidden" name="entry.1272730298" value="${q}">`; break;
          case "혈색 립밤": formEl.innerHTML+=`<input type="hidden" name="entry.2136390372" value="${q}">`; break;
          case "촉촉 플럼핑 립밤": formEl.innerHTML+=`<input type="hidden" name="entry.61250229" value="${q}">`; break;
          case "촉촉 립밤": formEl.innerHTML+=`<input type="hidden" name="entry.1050339042" value="${q}">`; break;
          case "수제비패드 60매": formEl.innerHTML+=`<input type="hidden" name="entry.202944705" value="${q}">`; break;
          case "화산석 오일 롤러": formEl.innerHTML+=`<input type="hidden" name="entry.1337141345" value="${q}">`; break;
          case "시어버터 핸드크림": formEl.innerHTML+=`<input type="hidden" name="entry.1635291501" value="${q}">`; break;
          case "바디 워시": formEl.innerHTML+=`<input type="hidden" name="entry.2132279447" value="${q}">`; break;
          case "바디 로션": formEl.innerHTML+=`<input type="hidden" name="entry.1886270070" value="${q}">`; break;
          case "바디 케어 세트": formEl.innerHTML+=`<input type="hidden" name="entry.1329246249" value="${q}">`; break;
        }
      });

      // 총 수량 / 결제 금액
      const totalQty = Object.values(cart).reduce((a,b)=>a+b,0);
      const totalAmt = Object.entries(cart).reduce((sum,[k,q])=> sum + q*productMap[k].price ,0);
      formEl.innerHTML+=`<input type="hidden" name="entry.307730166" value="${totalQty}">`;
      formEl.innerHTML+=`<input type="hidden" name="entry.1312485185" value="${totalAmt}">`;

      formEl.submit(); 
      for (const k of keys) delete cart[k]; 
      render();
      window.scrollTo({top:0,behavior:'smooth'}); 
      alert('제출되었습니다.');
    });

    async function loadProducts() {
      const res = await fetch("https://opensheet.elk.sh/1QpbkNSpsAoKhgMbCtHUhz97D5epuUqoGt7esf1-u-fw/sheet1");
      const rows = await res.json();
      const categories = {};
      rows.forEach(r=>{
        const cat=r["카테고리"]||"기타";
        if(!categories[cat]) categories[cat]=[];
        categories[cat].push({name:r["상품명"],price:Number(r["판매가"].replace(/,/g,"")),img:r["이미지"]});
      });

      Object.entries(categories).forEach(([catName,items],ci)=>{
        const sec=document.createElement('section');
        sec.className='cat'; sec.innerHTML=`<h3>${catName}</h3><div class="grid"></div>`;
        const grid=sec.querySelector('.grid');

        items.forEach((p,pi)=>{
          const key=`${ci}-${pi}`; productMap[key]=p;
          const src=p.img.startsWith("http")?p.img:`${IMG_BASE}/${p.img}`;
          const card=document.createElement('div'); card.className='product'; card.id=`card-${key}`;
          card.innerHTML=`
            <div class="topRow">
              <img class="p-thumb" alt="${p.name}" src="${src}">
              <div class="p-info"><div class="p-name">${p.name}</div><div class="p-price">${p.price.toLocaleString()}원</div></div>
            </div>
            <div class="qtyRow"><button class="btn" data-act="minus">−</button><div class="badge" id="badge-${key}">0</div><button class="btn" data-act="plus">＋</button></div>`;
          card.addEventListener('click',(e)=>{
            const act=e.target?.dataset?.act;
            if(act==='minus'){ if((cart[key]||0)>0) cart[key]--; if(cart[key]===0) delete cart[key]; }
            else { cart[key]=(cart[key]||0)+1; }
            render();
          });
          grid.appendChild(card);
        });

        catsEl.appendChild(sec);
      });
    }
    loadProducts();
  </script>
</body>
</html>
