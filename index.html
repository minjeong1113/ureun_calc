<script>
const SHEET_URL = "https://opensheet.elk.sh/1QpbkNSpsAoKhgMbCtHUhz97D5epuUqoGt7esf1-u-fw/sheet1";

let products = [];
let cart = {};

async function loadProducts() {
  try {
    const res = await fetch(SHEET_URL);
    const rows = await res.json();

    // ğŸ”¹ ì•ˆì „í•˜ê²Œ ë§¤í•‘
    products = rows.map(row => ({
      name: (row["ìƒí’ˆëª…"] || "").trim(),
      price: parseInt((row["íŒë§¤ê°€"] || "0").toString().replace(/[^\d]/g, "")),
      img: (row["ì´ë¯¸ì§€"] || "").trim(),
      category: (row["ì¹´í…Œê³ ë¦¬"] || "").trim()
    }));

    renderProducts();
  } catch (e) {
    console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
  }
}

function renderProducts() {
  const container = document.getElementById("products");
  container.innerHTML = "";

  // ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹í•‘
  const grouped = {};
  products.forEach(p => {
    if (!grouped[p.category]) grouped[p.category] = [];
    grouped[p.category].push(p);
  });

  Object.keys(grouped).forEach(cat => {
    const section = document.createElement("div");
    section.innerHTML = `<h3>${cat}</h3>`;
    const grid = document.createElement("div");
    grid.className = "grid";

    grouped[cat].forEach((p, idx) => {
      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <div class="thumb">
          <img src="${p.img}" alt="${p.name}" width="50" height="50">
          <div class="info">
            <div class="name">${p.name}</div>
            <div class="price">${p.price.toLocaleString()}ì›</div>
          </div>
        </div>
        <div class="qty">
          <button class="minus">-</button>
          <span class="count">${cart[p.name]?.count || 0}</span>
          <button class="plus">+</button>
        </div>
      `;

      // ìˆ˜ëŸ‰ ì¡°ì ˆ
      card.querySelector(".minus").onclick = () => updateCart(p, -1);
      card.querySelector(".plus").onclick = () => updateCart(p, 1);

      // ì¹´ë“œ í´ë¦­ â†’ ìˆ˜ëŸ‰ +1
      card.onclick = e => {
        if (!e.target.classList.contains("minus") && !e.target.classList.contains("plus")) {
          updateCart(p, 1);
        }
      };

      grid.appendChild(card);
    });

    section.appendChild(grid);
    container.appendChild(section);
  });

  renderCart();
}

function updateCart(product, delta) {
  if (!cart[product.name]) {
    cart[product.name] = { ...product, count: 0 };
  }
  cart[product.name].count += delta;
  if (cart[product.name].count <= 0) {
    delete cart[product.name];
  }
  renderProducts();
}

function renderCart() {
  const panel = document.getElementById("cart");
  panel.innerHTML = "";

  if (Object.keys(cart).length === 0) {
    panel.innerHTML = `<p>ì•„ì§ ì„ íƒëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
    return;
  }

  Object.values(cart).forEach(item => {
    const line = document.createElement("div");
    line.className = "cart-line";
    line.textContent = `${item.name} Ã— ${item.count}ê°œ = ${(item.count * item.price).toLocaleString()}ì›`;
    panel.appendChild(line);
  });

  const total = Object.values(cart).reduce((sum, i) => sum + i.count * i.price, 0);
  const totalDiv = document.createElement("div");
  totalDiv.className = "total";
  totalDiv.textContent = `ì´ í•©ê³„: ${total.toLocaleString()}ì›`;
  panel.appendChild(totalDiv);
}

loadProducts();
</script>
